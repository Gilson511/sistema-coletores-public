<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Base de Colaboradores</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="images/clipboard_1195513.png" type="image/x-icon" />
  <link rel="stylesheet" href="css/estilo.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>

<body>
  <div class="lado-direito usuario-logado">
    <span id="usuarioLogadoTexto"></span>
    <button onclick="logout()">Sair</button>
    <a href="dashboard.html" class="material-icons" title="Voltar ao menu"
      style="font-size: 35px;padding-top: 10px; color: #D5001C; text-decoration: none;">home</a>
  </div>
  </div>
  <hr style="border: 0.5; opacity: 0.3;">

  <div class="container">
    <h2>Cadastro de Colaboradores</h2>

    <form id="formColaborador" class="form">
      <div class="form-group">
        <label for="matricula">Matrícula</label>
        <input type="text" id="matricula" required>
      </div>
      <div class="form-group">
        <label for="nome_completo">Nome Completo</label>
        <input type="text" id="nome_completo" required>
      </div>
      <div class="form-group">
        <label for="turno">Turno</label>
        <select id="turno" required>
          <option value="">Selecione</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </div>
      <div class="form-group">
        <label for="setor">Setor</label>
        <select id="setor" required>
          <option value="">Selecione</option>
          <option value="Separação">Separação</option>
          <option value="Expedição">Expedição</option>
          <option value="Inbound">Inbound</option>
        </select>
      </div>
      <div class="form-group">
        <label for="encarregado">Encarregado</label>
        <select id="encarregado" required>
          <option value="">Selecione</option>
          <option value="Adriano">Adriano</option>
          <option value="Yasmim">Isabela</option>
          <option value="Dany">Dany</option>
        </select>
      </div>
      <button type="submit">Cadastrar</button>
    </form>

    <div class="form-group">
      <label for="excelFile">Importar de Arquivo Excel:</label>
      <input type="file" id="excelFile" accept=".xlsx, .xls" />
      <button type="button" onclick="importarExcel()">Importar Excel</button>
    </div>


    <div id="mensagem" class="mensagem-alerta" style="display: none;"></div>

    <table>
      <thead>
        <tr>
          <th>Matrícula</th>
          <th>Nome</th>
          <th>Turno</th>
          <th>Setor</th>
          <th>Encarregado</th>
        </tr>
        <tr>
          <th><input type="text" placeholder="Filtrar RE" onkeyup="filtrarTabela(0, this.value)" /></th>
          <th><input type="text" placeholder="Filtrar Nome" onkeyup="filtrarTabela(1, this.value)" /></th>
          <th><input type="text" placeholder="Filtrar turno" onkeyup="filtrarTabela(2, this.value)" /></th>
          <th><input type="text" placeholder="Filtrar setor" onkeyup="filtrarTabela(3, this.value)" /></th>
          <th><input type="text" placeholder="Filtrar encarregado" onkeyup="filtrarTabela(4, this.value)" /></th>
          <th><button onclick="limparFiltros()">Limpar Filtros</button></th>
        </tr>
      </thead>
      <tbody id="tabela-colaboradores"></tbody>
    </table>
  </div>

  <script>

    function importarExcel() {
      const fileInput = document.getElementById("excelFile");
      const file = fileInput.files[0];

      if (!file) {
        exibirMensagem("Selecione um arquivo Excel válido.", "error");
        return;
      }

      const reader = new FileReader();

      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const colaboradores = XLSX.utils.sheet_to_json(sheet);

        const camposObrigatorios = ["matricula", "nome_completo", "turno", "setor", "encarregado"];
        let ignorados = 0;

        colaboradores.forEach(async (colab) => {
          const incompleto = camposObrigatorios.some(campo => !colab[campo]);
          if (incompleto) {
            ignorados++;
            console.warn("Linha ignorada por falta de campos:", colab);
            return;
          }

          try {
            const res = await fetch(baseURL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(colab),
            });

            if (!res.ok) throw new Error();
          } catch (err) {
            console.error("Erro ao importar:", colab, err);
          }
        });

        const msg = ignorados > 0
          ? `Importação concluída com ${ignorados} linha(s) ignorada(s).`
          : "Importação concluída com sucesso!";
        exibirMensagem(msg, "success");

        setTimeout(carregarColaboradores, 1000);
      };

      reader.readAsArrayBuffer(file);
    }


    const baseURL = "http://localhost:3000/api/colaboradores";
    const form = document.getElementById("formColaborador");
    const mensagem = document.getElementById("mensagem");
    const tabela = document.getElementById("tabela-colaboradores");

    let editandoMatricula = null; // controle de edição

    function exibirMensagem(texto, tipo) {
      mensagem.textContent = texto;
      mensagem.className = `mensagem-alerta ${tipo}`;
      mensagem.style.display = "block";
      setTimeout(() => mensagem.style.display = "none", 3000);
    }

    function carregarColaboradores() {
      fetch(baseURL)
        .then(res => res.json())
        .then(data => {
          tabela.innerHTML = "";
          data.forEach(colab => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${colab.matricula}</td>
              <td>${colab.nome_completo}</td>
              <td>${colab.turno}</td>
              <td>${colab.setor}</td>
              <td>${colab.encarregado}</td>
              <td>
                <button onclick="editarColaborador('${colab.matricula}')">Editar</button>
                <button id="atualizar-${colab.matricula}" onclick="confirmarAtualizacao('${colab.matricula}')" disabled>Atualizar</button>
                <button onclick="excluirColaborador('${colab.matricula}')">Excluir</button>
              </td>
            `;
            tabela.appendChild(tr);
          });
        });
    }

    async function excluirColaborador(matricula) {
      if (!confirm("Tem certeza que deseja excluir este colaborador?")) return;

      try {
        const res = await fetch(`${baseURL}/${matricula}`, { method: "DELETE" });
        if (!res.ok) throw new Error();
        exibirMensagem("Colaborador excluído com sucesso!", "success");
        carregarColaboradores();
      } catch {
        exibirMensagem("Erro ao excluir colaborador.", "error");
      }
    }


    function confirmarAtualizacao(matricula) {
      document.querySelector("form").dispatchEvent(new Event("submit")); // força o envio do formulário
    }

    function editarColaborador(matricula) {
      fetch(`${baseURL}/${matricula}`)
        .then(res => res.json())
        .then(colab => {
          document.getElementById("matricula").value = colab.matricula;
          document.getElementById("nome_completo").value = colab.nome_completo;
          document.getElementById("turno").value = colab.turno;
          document.getElementById("setor").value = colab.setor;
          document.getElementById("encarregado").value = colab.encarregado;
          editandoMatricula = matricula;

          // Habilita o botão de atualizar da linha correspondente
          document.querySelectorAll("button[id^='atualizar-']").forEach(btn => btn.disabled = true);
          const btnAtualizar = document.getElementById(`atualizar-${matricula}`);
          if (btnAtualizar) btnAtualizar.disabled = false;
        });
    }


    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const dados = {
        matricula: document.getElementById("matricula").value.trim(),
        nome_completo: document.getElementById("nome_completo").value.trim(),
        turno: document.getElementById("turno").value,
        setor: document.getElementById("setor").value,
        encarregado: document.getElementById("encarregado").value
      };

      if (!dados.matricula || !dados.nome_completo || !dados.turno || !dados.setor || !dados.encarregado) {
        exibirMensagem("Preencha todos os campos.", "error");
        return;
      }

      try {
        const metodo = editandoMatricula ? "PUT" : "POST";
        const url = editandoMatricula ? `${baseURL}/${editandoMatricula}` : baseURL;

        const res = await fetch(url, {
          method: metodo,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dados)
        });

        if (!res.ok) throw new Error();

        exibirMensagem(editandoMatricula ? "Colaborador atualizado!" : "Colaborador cadastrado!", "success");
        form.reset();
        editandoMatricula = null;
        form.querySelector("button[type='submit']").textContent = "Cadastrar";
        carregarColaboradores();
      } catch {
        exibirMensagem("Erro ao salvar colaborador.", "error");
      }
    });

    window.onload = () => {
      carregarColaboradores();
      const usuario = localStorage.getItem("usuarioLogado");
      if (usuario) {
        document.getElementById("usuarioLogadoTexto").textContent = `Usuário: ${usuario}`;
      }
    };

    function logout() {
      localStorage.removeItem("usuarioLogado");
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }

    function filtrarTabela(colunaIndex, valor) {
      const linhas = document.querySelectorAll("#tabela-colaboradores tr");
      const filtro = valor.toLowerCase();

      linhas.forEach(linha => {
        const celula = linha.cells[colunaIndex];
        if (celula) {
          const conteudo = celula.textContent.toLowerCase();
          linha.style.display = conteudo.includes(filtro) ? "" : "none";
        }
      });
    }


    function limparFiltros() {
      document.querySelectorAll("table thead input").forEach(i => i.value = "");
      document.querySelectorAll("#tabela-colaboradores tr").forEach(l => l.style.display = "");
    }

  </script>

  <footer class="rodape-sistema">
    <div class="rodape-conteudo">
      <p>© 2025 Sistema de Coletores | Suporte:
        <a href="https://mail.google.com/mail/?view=cm&fs=1&to=gilson.araujo@jsl.com.br.com&su=Suporte%20-%20Sistema%20de%20Coletores&body=Olá,%20gostaria%20de%20tirar%20uma%20dúvida%20ou%20fazer%20uma%20sugestão."
          target="_blank">
          gilson.araujo@jsl.com.br
        </a>
      </p>
      <p>Telefone para contato: <a href="tel:+550000000000">(35) 9974-48246</a></p>
    </div>
  </footer>
</body>

</html>