<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Cadastro de Coletor</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="images/clipboard_1195513.png" type="image/x-icon" />
  <link rel="stylesheet" href="css/estilo.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
  <div class="usuario-logado">
    <p id="usuarioLogadoTexto"></p>
    <button onclick="logout()">Sair</button>
  </div>

  <a href="dashboard.html" class="material-icons" title="Voltar ao menu"
    style="font-size: 35px; color: #333; text-decoration: none;padding-left: 5px;position: fixed;">home</a>

  <hr style="border: 0.5; opacity: 0.3;">

  <div class="container">
    <h2>Sistema de Coletores - Cadastro</h2>
    <div id="mensagem" class="mensagem-alerta hidden"></div>

    <form id="formColetor" class="form">
      <div class="form-group">
        <label for="re">RE</label>
        <input type="text" id="re" required>
      </div>

      <div class="form-group">
        <label for="numero_coletor">Número do Coletor</label>
        <input type="text" id="numero_coletor" required>
      </div>

      <div class="form-group">
        <label for="encarregado">Encarregado</label>
        <select id="encarregado" required>
          <option value="">Selecione</option>
          <option value="Adriano">Adriano</option>
          <option value="Isabela">Isabela</option>
          <option value="Dany">Dany</option>
          <option value="Flávio">Flávio</option>
        </select>
      </div>

      <div class="form-group">
        <label for="turno">Turno</label>
        <select id="turno" required>
          <option value="">Selecione</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </div>

      <div class="form-group">
        <label for="setor">Setor</label>
        <select id="setor" required>
          <option value="">Selecione</option>
          <option value="Separacao">Separacão</option>
          <option value="Expedicao">Expedicão</option>
          <option value="Inbound">Inbound</option>
        </select>
      </div>

      <div class="form-group">
        <label for="hora_pegou">Data e Hora que fez retirada</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="datetime-local" id="hora_pegou" required>
          <span onclick="inserirDataHoraAtual('hora_pegou')" title="Inserir data e hora atual" style="cursor: pointer;"
            class="material-icons">schedule</span>
        </div>
      </div>

      <div class="form-group-baixa" style="display: none;">

        <label for="hora_baixa">Data e Hora que Deu Baixa</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="datetime-local" id="hora_baixa">
          <span onclick="inserirDataHoraAtual('hora_baixa')" title="Inserir data e hora atual" style="cursor: pointer;"
            class="material-icons">schedule</span>
        </div>
      </div>

      <div class="form-group">
        <label for="estado">Observações sobre o coletor</label>
        <input type="text" id="estado">
      </div>


      <div class="form-group">

        <div class="botao">
          <div><button type="submit">Salvar Coletor</button></div>
          <div><a href="dashboard.html" class="btn-voltar">Voltar ao Menu</a></div>
        </div>
    </form>
  </div>

  <script>

    // funçoes para data e hora atuais. 


    // Função corrigida para inserir data e hora locais corretamente
    function inserirDataHoraAtual(id) {
      const agora = new Date();

      // Corrige o deslocamento de fuso horário (UTC → Local)
      const offsetMs = agora.getTimezoneOffset() * 60000;
      const localISOTime = new Date(agora - offsetMs).toISOString().slice(0, 16);
      // Formato: yyyy-MM-ddTHH:mm

      document.getElementById(id).value = localISOTime;
    }


    function exibirMensagem(texto, tipo = "success") {
      const msg = document.getElementById("mensagem");
      msg.textContent = texto;
      msg.className = `mensagem-alerta ${tipo}`;
      msg.classList.remove("hidden");

      setTimeout(() => {
        msg.style.opacity = "0";
        setTimeout(() => {
          msg.classList.add("hidden");
          msg.style.opacity = "1";
        }, 500);
      }, 3000);
    }

    window.onload = function () {
      const usuario = localStorage.getItem("usuarioLogado");

      const saudacao = document.getElementById("usuarioLogadoTexto");

      if (usuario && saudacao) {
        saudacao.textContent = `Usuário logado: ${usuario}`;
      } else {
        // Esconde botão e texto de logout se não estiver logado
        document.querySelector(".usuario-logado").style.display = "none";
      }
    };


    function logout() {
      localStorage.removeItem("usuarioLogado");
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }


    document.getElementById("formColetor").addEventListener("submit", async function (e) {
      e.preventDefault();

      const numeroInformado = document.getElementById("numero_coletor").value
        .trim()
        .replace(/[\s\r\n\t]/g, '');

      const reInformado = document.getElementById("re").value
        .trim()

      try {
        // Verifica se o número existe na base
        const respostaBase = await fetch("http://localhost:3000/api/basecoletores");
        const baseColetores = await respostaBase.json();
        const numeroExisteNaBase = baseColetores.some(c => c.numero_coletor === numeroInformado);

        if (!numeroExisteNaBase) {
          exibirMensagem("⚠️ Este coletor não está na base de coletores.", "error");
          formColetor.reset(); // reseta o formulario
          return;
        }
        // Verifica se já existe na tabela de registros
        const respostaTabela = await fetch("http://localhost:3000/api/coletores");
        const registros = await respostaTabela.json();
        const duplicado = registros.some(c => c.numero_coletor === numeroInformado);
        const usuarioTemRetiradaPendente = registros.some(c => c.re === reInformado && !c.hora_baixa);


        if (duplicado) {
          exibirMensagem("⚠️ Este coletor já está em uso. Informe outro número.", "error");
          return;
        }

        if (usuarioTemRetiradaPendente) {
          exibirMensagem("⚠️ Essa mátricula já está em uso, fazer a baixa para próxima retirada.", "error");
          return;
        }

        //verifica se o usuario ja existe na tabela coletores, pois ele nao pode retirar dois RF. 

        const coletor = {
          re: document.getElementById("re").value,
          numero_coletor: numeroInformado,
          encarregado: document.getElementById("encarregado").value,
          turno: document.getElementById("turno").value,
          setor: document.getElementById("setor").value,
          hora_pegou: document.getElementById("hora_pegou").value,
          hora_baixa: document.getElementById("hora_baixa").value || "",
          estado: document.getElementById("estado").value
        };

        const response = await fetch("http://localhost:3000/api/coletores", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(coletor)
        });

        if (!response.ok) throw new Error("Erro ao cadastrar coletor");

        exibirMensagem("✅ Coletor cadastrado com sucesso!", "success");
        this.reset();
      } catch (error) {
        console.error(error);
        exibirMensagem("❌ Erro ao cadastrar coletor.", "error");
      }
    });
  </script>

  <footer class="rodape-sistema">
    <div class="rodape-conteudo">
      <p>© 2025 Sistema de Coletores | Suporte:
        <a href="https://mail.google.com/mail/?view=cm&fs=1&to=gilson.araujo@jsl.com.br.com&su=Suporte%20-%20Sistema%20de%20Coletores&body=Olá,%20gostaria%20de%20tirar%20uma%20dúvida%20ou%20fazer%20uma%20sugestão."
          target="_blank">
          gilson.araujo@jsl.com.br
        </a>
      </p>
      <p>Telefone para contato: <a href="tel:+550000000000">(35) 9974-48246</a></p>
    </div>
  </footer>
</body>

</html>